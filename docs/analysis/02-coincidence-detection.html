<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Coincidence Detection using Distances: Simulations – Estimating Set Size by Cascading Exclusion</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Estimating Set Size by Cascading Exclusion</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../analysis/01-convex-hulls.html"> 
<span class="menu-text">Convex Hulls</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../analysis/02-coincidence-detection.html" aria-current="page"> 
<span class="menu-text">Minimum Distance distributions</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../analysis/03-bacterialdata.html"> 
<span class="menu-text">Bacterial Coincidence</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../analysis/04-prediction-sets-regression.html"> 
<span class="menu-text">Prediction Sets</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#part-1-random-split-analysis" id="toc-part-1-random-split-analysis" class="nav-link" data-scroll-target="#part-1-random-split-analysis">Part 1: Random Split Analysis</a></li>
  <li><a href="#part-2-distance-distributions-comparison-and-ad-computation" id="toc-part-2-distance-distributions-comparison-and-ad-computation" class="nav-link" data-scroll-target="#part-2-distance-distributions-comparison-and-ad-computation">Part 2: Distance Distributions Comparison and AD computation</a>
  <ul class="collapse">
  <li><a href="#plots-comparing-four-of-the-distance-pairs-for-figure-7a" id="toc-plots-comparing-four-of-the-distance-pairs-for-figure-7a" class="nav-link" data-scroll-target="#plots-comparing-four-of-the-distance-pairs-for-figure-7a">Plots comparing four of the distance pairs for Figure 7a</a></li>
  <li><a href="#histogram-of-anderson-darling-500-stats-for-7b" id="toc-histogram-of-anderson-darling-500-stats-for-7b" class="nav-link" data-scroll-target="#histogram-of-anderson-darling-500-stats-for-7b">Histogram of Anderson –Darling 500 stats for 7b</a></li>
  </ul></li>
  <li><a href="#part-3-null-distribution-of-andersondarling-generation" id="toc-part-3-null-distribution-of-andersondarling-generation" class="nav-link" data-scroll-target="#part-3-null-distribution-of-andersondarling-generation">Part 3: Null Distribution of Anderson–Darling : Generation</a>
  <ul class="collapse">
  <li><a href="#create-metapopulation" id="toc-create-metapopulation" class="nav-link" data-scroll-target="#create-metapopulation">Create metapopulation</a></li>
  <li><a href="#generate-clean_null_ad_distribution-with-independent-samples" id="toc-generate-clean_null_ad_distribution-with-independent-samples" class="nav-link" data-scroll-target="#generate-clean_null_ad_distribution-with-independent-samples">Generate clean_null_ad_distribution with independent samples</a></li>
  <li><a href="#compare-the-densities-of-the-500-random-splits-ad-to-the-null-generated-above" id="toc-compare-the-densities-of-the-500-random-splits-ad-to-the-null-generated-above" class="nav-link" data-scroll-target="#compare-the-densities-of-the-500-random-splits-ad-to-the-null-generated-above">Compare the densities of the 500 random splits AD to the null generated above</a></li>
  </ul></li>
  <li><a href="#part-4-final-comparison-through-a-quantile-quantile-plot" id="toc-part-4-final-comparison-through-a-quantile-quantile-plot" class="nav-link" data-scroll-target="#part-4-final-comparison-through-a-quantile-quantile-plot">Part 4: Final Comparison through a quantile-quantile plot</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Coincidence Detection using Distances: Simulations</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
<p class="subtitle lead">Leave-one-out density comparisons and Anderson–Darling null distribution generation</p>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p>This analysis implements coincidence detection methods using genetic distances computed with the leave one out method.</p>
</section>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<div class="cell">
<details class="code-fold">
<summary>Load Libraries and Helper Functions</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Biostrings)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ape)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(kSamples)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">201123</span>)  <span class="co"># For reproducibility</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the data</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>aligned_seqs <span class="ot">&lt;-</span> <span class="fu">readDNAStringSet</span>(<span class="st">"../data/silva_aligned_bacteria_sequences.fasta"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Loaded"</span>, <span class="fu">length</span>(aligned_seqs), <span class="st">"sequences</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded 205 sequences</code></pre>
</div>
</div>
</section>
<section id="part-1-random-split-analysis" class="level2">
<h2 class="anchored" data-anchor-id="part-1-random-split-analysis">Part 1: Random Split Analysis</h2>
<p>The original simulation with random 40/160 splits, we generate <code>ad_distribution</code> and make helper distance functions for the splits.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to compute within-sample minimum distances (excluding self-distances)</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>compute_within_sample_min_distances <span class="ot">&lt;-</span> <span class="cf">function</span>(dist_mat, sample_indices) {</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  sample_dist_mat <span class="ot">&lt;-</span> dist_mat[sample_indices, sample_indices]</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  min_distances <span class="ot">&lt;-</span> <span class="fu">apply</span>(sample_dist_mat, <span class="dv">1</span>, <span class="cf">function</span>(row) {</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    non_zero_distances <span class="ot">&lt;-</span> row[row <span class="sc">&gt;</span> <span class="dv">0</span>]  <span class="co"># Exclude self-distances (zeros)</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(non_zero_distances) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fu">min</span>(non_zero_distances))</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NA</span>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(min_distances[<span class="sc">!</span><span class="fu">is.na</span>(min_distances)])  <span class="co"># Remove any NAs</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to compute sample-to-population minimum distances</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>compute_sample_to_population_min_distances <span class="ot">&lt;-</span> <span class="cf">function</span>(dist_mat, population_indices, sample_indices) {</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Distances from population to sample</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>  pop_to_sample_dist_mat <span class="ot">&lt;-</span> dist_mat[population_indices, sample_indices]</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  min_distances <span class="ot">&lt;-</span> <span class="fu">apply</span>(pop_to_sample_dist_mat, <span class="dv">1</span>, min)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(min_distances)</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Main simulation function</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>simulate_ad_statistics <span class="ot">&lt;-</span> <span class="cf">function</span>(seqs, <span class="at">n_simulations =</span> <span class="dv">500</span>) {</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute distance matrix once</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Computing distance matrix...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  dist_matrix <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">dist.dna</span>(<span class="fu">as.DNAbin</span>(seqs), <span class="at">model =</span> <span class="st">"K80"</span>, <span class="at">pairwise.deletion =</span> <span class="cn">TRUE</span>))</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  ad_statistics <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n_simulations)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Running"</span>, n_simulations, <span class="st">"simulations...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_simulations) {</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">%%</span> <span class="dv">50</span> <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">cat</span>(<span class="st">"Simulation"</span>, i, <span class="st">"of"</span>, n_simulations, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Randomly split 200 sequences into sample (40) and population (160)</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    random_indices <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(dist_matrix), <span class="dv">200</span>)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    sample_indices <span class="ot">&lt;-</span> random_indices[<span class="dv">1</span><span class="sc">:</span><span class="dv">40</span>]</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    population_indices <span class="ot">&lt;-</span> random_indices[<span class="dv">41</span><span class="sc">:</span><span class="dv">200</span>]</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute within-sample minimum distances (n1 = up to 40, but typically 39 per point in this part)</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    within_sample_distances <span class="ot">&lt;-</span> <span class="fu">compute_within_sample_min_distances</span>(dist_matrix, sample_indices)</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute sample-to-population minimum distances (n2 = 160)</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    sample_to_pop_distances <span class="ot">&lt;-</span> <span class="fu">compute_sample_to_population_min_distances</span>(dist_matrix, population_indices, sample_indices)</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute Anderson-Darling statistic</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(within_sample_distances) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(sample_to_pop_distances) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>      ad_result <span class="ot">&lt;-</span> <span class="fu">ad.test</span>(within_sample_distances, sample_to_pop_distances)</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>      ad_statistics[i] <span class="ot">&lt;-</span> ad_result<span class="sc">$</span>ad[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>      ad_statistics[i] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove any failed simulations</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>  ad_statistics <span class="ot">&lt;-</span> ad_statistics[<span class="sc">!</span><span class="fu">is.na</span>(ad_statistics)]</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Completed"</span>, <span class="fu">length</span>(ad_statistics), <span class="st">"successful simulations</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(ad_statistics)</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the simulations</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># This was the original one </span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>ad_distribution <span class="ot">&lt;-</span> <span class="fu">simulate_ad_statistics</span>(aligned_seqs, <span class="at">n_simulations =</span> <span class="dv">500</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Computing distance matrix...
Running 500 simulations...
Simulation 50 of 500 
Simulation 100 of 500 
Simulation 150 of 500 
Simulation 200 of 500 
Simulation 250 of 500 
Simulation 300 of 500 
Simulation 350 of 500 
Simulation 400 of 500 
Simulation 450 of 500 
Simulation 500 of 500 
Completed 500 successful simulations</code></pre>
</div>
</div>
</section>
<section id="part-2-distance-distributions-comparison-and-ad-computation" class="level2">
<h2 class="anchored" data-anchor-id="part-2-distance-distributions-comparison-and-ad-computation">Part 2: Distance Distributions Comparison and AD computation</h2>
<p>Here we are using our distance between and within functions to compare the leave one out for 40 point to the “true” distance computation for 160.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The 4 selected simulations with density plots</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Show within-sample vs sample-to-population distances</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Save distance distributions for selected simulations</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>simulate_ad_statistics_with_distances <span class="ot">&lt;-</span> <span class="cf">function</span>(seqs, <span class="at">n_simulations =</span> <span class="dv">500</span>, <span class="at">save_simulations =</span> <span class="fu">c</span>(<span class="dv">150</span>, <span class="dv">200</span>, <span class="dv">250</span>, <span class="dv">450</span>)) {</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute distance matrix once</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Computing distance matrix...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  dist_matrix <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">dist.dna</span>(<span class="fu">as.DNAbin</span>(seqs), <span class="at">model =</span> <span class="st">"K80"</span>, <span class="at">pairwise.deletion =</span> <span class="cn">TRUE</span>))</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  ad_statistics <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n_simulations)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  saved_distances <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Running"</span>, n_simulations, <span class="st">"simulations...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_simulations) {</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">%%</span> <span class="dv">50</span> <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">cat</span>(<span class="st">"Simulation"</span>, i, <span class="st">"of"</span>, n_simulations, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Randomly split 200 sequences into sample (40) and population (160)</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    random_indices <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(dist_matrix), <span class="dv">200</span>)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    sample_indices <span class="ot">&lt;-</span> random_indices[<span class="dv">1</span><span class="sc">:</span><span class="dv">40</span>]</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    population_indices <span class="ot">&lt;-</span> random_indices[<span class="dv">41</span><span class="sc">:</span><span class="dv">200</span>]</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute within-sample minimum distances (n1 = up to 40, but typically 39 per point)</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    within_sample_distances <span class="ot">&lt;-</span> <span class="fu">compute_within_sample_min_distances</span>(dist_matrix, sample_indices)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute sample-to-population minimum distances (n2 = 160)</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    sample_to_pop_distances <span class="ot">&lt;-</span> <span class="fu">compute_sample_to_population_min_distances</span>(dist_matrix, population_indices, sample_indices)</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save distances for selected simulations</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">%in%</span> save_simulations) {</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>      saved_distances[[<span class="fu">as.character</span>(i)]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>        <span class="at">within_sample =</span> within_sample_distances,</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>        <span class="at">sample_to_pop =</span> sample_to_pop_distances</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute Anderson-Darling statistic</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(within_sample_distances) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(sample_to_pop_distances) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>      ad_result <span class="ot">&lt;-</span> <span class="fu">ad.test</span>(within_sample_distances, sample_to_pop_distances)</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>      ad_statistics[i] <span class="ot">&lt;-</span> ad_result<span class="sc">$</span>ad[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>      ad_statistics[i] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove any failed simulations</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>  ad_statistics <span class="ot">&lt;-</span> ad_statistics[<span class="sc">!</span><span class="fu">is.na</span>(ad_statistics)]</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Completed"</span>, <span class="fu">length</span>(ad_statistics), <span class="st">"successful simulations</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">ad_statistics =</span> ad_statistics, <span class="at">saved_distances =</span> saved_distances))</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the simulations with distance saving</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">simulate_ad_statistics_with_distances</span>(aligned_seqs, <span class="at">n_simulations =</span> <span class="dv">500</span>, </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">save_simulations =</span> <span class="fu">c</span>(<span class="dv">150</span>, <span class="dv">200</span>, <span class="dv">250</span>, <span class="dv">450</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Computing distance matrix...
Running 500 simulations...
Simulation 50 of 500 
Simulation 100 of 500 
Simulation 150 of 500 
Simulation 200 of 500 
Simulation 250 of 500 
Simulation 300 of 500 
Simulation 350 of 500 
Simulation 400 of 500 
Simulation 450 of 500 
Simulation 500 of 500 
Completed 500 successful simulations</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>ad_distribution <span class="ot">&lt;-</span> results<span class="sc">$</span>ad_statistics</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>saved_distances <span class="ot">&lt;-</span> results<span class="sc">$</span>saved_distances</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="plots-comparing-four-of-the-distance-pairs-for-figure-7a" class="level3">
<h3 class="anchored" data-anchor-id="plots-comparing-four-of-the-distance-pairs-for-figure-7a">Plots comparing four of the distance pairs for Figure 7a</h3>
<p>Make the comparison densities and the Anderson – Darling histogram for the 500 simulations of splits.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create density plots for the 4 selected simulations</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>density_plots <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(saved_distances)) {</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  sim_num <span class="ot">&lt;-</span> <span class="fu">names</span>(saved_distances)[i]</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  within_dist <span class="ot">&lt;-</span> saved_distances[[sim_num]]<span class="sc">$</span>within_sample</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  between_dist <span class="ot">&lt;-</span> saved_distances[[sim_num]]<span class="sc">$</span>sample_to_pop</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create combined data frame</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  plot_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">distance =</span> <span class="fu">c</span>(within_dist, between_dist),</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"Within-Sample"</span>, <span class="fu">length</span>(within_dist)), </span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">rep</span>(<span class="st">"Sample-to-Population"</span>, <span class="fu">length</span>(between_dist))))</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate AD statistic for this simulation</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>  ad_stat <span class="ot">&lt;-</span> <span class="fu">round</span>(ad_distribution[<span class="fu">as.numeric</span>(sim_num)], <span class="dv">3</span>)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>  density_plots[[i]] <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plot_data, <span class="fu">aes</span>(<span class="at">x =</span> distance, <span class="at">fill =</span> type)) <span class="sc">+</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Within-Sample"</span> <span class="ot">=</span> <span class="st">"blue"</span>, <span class="st">"Sample-to-Population"</span> <span class="ot">=</span> <span class="st">"red"</span>)) <span class="sc">+</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="co">#title = paste("Simulation", sim_num, "- AD =", ad_stat),</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Minimum Distance"</span>,</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>         <span class="at">y =</span> <span class="st">"Density"</span>,</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>         <span class="at">fill =</span> <span class="st">"Distance Type"</span>) <span class="sc">+</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Arrange the 4 density plots in a 2x2 grid</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>combined_density_plot <span class="ot">&lt;-</span> <span class="fu">grid.arrange</span>(density_plots[[<span class="dv">1</span>]], density_plots[[<span class="dv">2</span>]], </span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>                                     density_plots[[<span class="dv">3</span>]], density_plots[[<span class="dv">4</span>]], </span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">nrow =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="02-coincidence-detection_files/figure-html/simul4-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Four exemplary simulations and the two densities compared.</figcaption>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>combined_density_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>TableGrob (2 x 2) "arrange": 4 grobs
  z     cells    name           grob
1 1 (1-1,1-1) arrange gtable[layout]
2 2 (1-1,2-2) arrange gtable[layout]
3 3 (2-2,1-1) arrange gtable[layout]
4 4 (2-2,2-2) arrange gtable[layout]</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the combined plot for Figure left side</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave("four_density_comparisons.png", combined_density_plot, width = 4, height = 4, dpi = 300)</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary statistics</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Summary of AD Statistics:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Summary of AD Statistics:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Mean:"</span>, <span class="fu">mean</span>(ad_distribution), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Mean: 1.545891 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Median:"</span>, <span class="fu">median</span>(ad_distribution), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Median: 1.21445 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"95th Percentile:"</span>, <span class="fu">quantile</span>(ad_distribution, <span class="fl">0.95</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>95th Percentile: 3.874305 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Standard Deviation:"</span>, <span class="fu">sd</span>(ad_distribution), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Standard Deviation: 1.085291 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print AD statistics for the selected simulations</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">AD Statistics for selected simulations:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
AD Statistics for selected simulations:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(sim_num <span class="cf">in</span> <span class="fu">names</span>(saved_distances)) {</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Simulation"</span>, sim_num, <span class="st">": AD ="</span>, <span class="fu">round</span>(ad_distribution[<span class="fu">as.numeric</span>(sim_num)], <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Simulation 150 : AD = 0.867 
Simulation 200 : AD = 1.0111 
Simulation 250 : AD = 2.4349 
Simulation 450 : AD = 3.6647 </code></pre>
</div>
</div>
</section>
<section id="histogram-of-anderson-darling-500-stats-for-7b" class="level3">
<h3 class="anchored" data-anchor-id="histogram-of-anderson-darling-500-stats-for-7b">Histogram of Anderson –Darling 500 stats for 7b</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the  histogram for Figure 7b, no title </span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>hist_plot_nt <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="fu">data.frame</span>(<span class="at">ad_statistic =</span> ad_distribution), <span class="fu">aes</span>(<span class="at">x =</span> ad_statistic)) <span class="sc">+</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="fl">0.2</span>, <span class="at">fill =</span> <span class="st">"lightblue"</span>, <span class="at">color =</span> <span class="st">"darkblue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> <span class="fu">median</span>(ad_statistic)), <span class="at">color =</span> <span class="st">"darkblue"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="fu">aes</span>(<span class="at">xintercept =</span> <span class="fu">quantile</span>(ad_statistic, <span class="fl">0.95</span>)), <span class="at">color =</span> <span class="st">"purple"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Anderson-Darling Statistic"</span>,</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Frequency"</span>) <span class="sc">+</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fu">median</span>(ad_distribution)<span class="sc">+</span><span class="fl">0.6</span>, <span class="at">y =</span> <span class="dv">60</span>, </span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">paste</span>(<span class="st">"Median ="</span>, <span class="fu">round</span>(<span class="fu">median</span>(ad_distribution), <span class="dv">2</span>)), <span class="at">vjust =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"darkblue"</span>) <span class="sc">+</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fu">quantile</span>(ad_distribution, <span class="fl">0.95</span>), <span class="at">y =</span> <span class="fu">max</span>(<span class="fu">table</span>(<span class="fu">cut</span>(ad_distribution, <span class="at">breaks =</span> <span class="dv">20</span>)))<span class="sc">*</span><span class="fl">0.1</span>, </span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="fu">paste</span>(<span class="st">"95th % ="</span>, <span class="fu">round</span>(<span class="fu">quantile</span>(ad_distribution, <span class="fl">0.95</span>), <span class="dv">2</span>)), <span class="at">vjust =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">color =</span> <span class="st">"purple"</span>)</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(hist_plot_nt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="02-coincidence-detection_files/figure-html/hist7b-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Histogram of the 500 Anderson–Statistic comparing the 40 LOO distances and the 160 sample to population ones.</figcaption>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave("ADhistogram.png",hist_plot_nt,width=5,height=4)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="part-3-null-distribution-of-andersondarling-generation" class="level2">
<h2 class="anchored" data-anchor-id="part-3-null-distribution-of-andersondarling-generation">Part 3: Null Distribution of Anderson–Darling : Generation</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Bootstrap + mutate to create 1000-sequence population</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to bootstrap and mutate sequences (your existing code)</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>bootstrap_and_mutate_sequences <span class="ot">&lt;-</span> <span class="cf">function</span>(seqs, n, <span class="at">mutation_rate =</span> <span class="fl">0.01</span>) {</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  bootstrapped_seqs <span class="ot">&lt;-</span> <span class="fu">sample</span>(seqs, n, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  mutated_seqs <span class="ot">&lt;-</span> <span class="fu">sapply</span>(bootstrapped_seqs, <span class="cf">function</span>(seq) {</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    seq_vector <span class="ot">&lt;-</span> <span class="fu">strsplit</span>(<span class="fu">as.character</span>(seq), <span class="st">""</span>)[[<span class="dv">1</span>]]</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    mutation_sites <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">runif</span>(<span class="fu">length</span>(seq_vector)) <span class="sc">&lt;</span> mutation_rate)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    seq_vector[mutation_sites] <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"A"</span>, <span class="st">"C"</span>, <span class="st">"G"</span>, <span class="st">"T"</span>), <span class="fu">length</span>(mutation_sites), <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">paste</span>(seq_vector, <span class="at">collapse =</span> <span class="st">""</span>)</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">DNAStringSet</span>(mutated_seqs))</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="create-metapopulation" class="level3">
<h3 class="anchored" data-anchor-id="create-metapopulation">Create metapopulation</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>population_size <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Creating metapopulation of"</span>, population_size, <span class="st">"sequences...</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Creating metapopulation of 1000 sequences...</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>population_seqs <span class="ot">&lt;-</span> <span class="fu">bootstrap_and_mutate_sequences</span>(aligned_seqs, population_size, <span class="at">mutation_rate =</span> <span class="fl">0.01</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="generate-clean_null_ad_distribution-with-independent-samples" class="level3">
<h3 class="anchored" data-anchor-id="generate-clean_null_ad_distribution-with-independent-samples">Generate clean_null_ad_distribution with independent samples</h3>
<p>Null from 40 random to 40 random and 160 random to 40 random</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to generate the clean null distribution (all independent random sets)</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>generate_clean_null_ad_distribution <span class="ot">&lt;-</span> <span class="cf">function</span>(metapopulation_seqs, <span class="at">n_simulations =</span> <span class="dv">500</span>) {</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute distance matrix for the entire metapopulation once</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Computing distance matrix for metapopulation...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  dist_matrix <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">dist.dna</span>(<span class="fu">as.DNAbin</span>(metapopulation_seqs), <span class="at">model =</span> <span class="st">"K80"</span>, <span class="at">pairwise.deletion =</span> <span class="cn">TRUE</span>))</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  clean_null_ad_statistics <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n_simulations)</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Generating clean null distribution with"</span>, n_simulations, <span class="st">"simulations...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_simulations) {</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(i <span class="sc">%%</span> <span class="dv">50</span> <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">cat</span>(<span class="st">"Clean null simulation"</span>, i, <span class="st">"of"</span>, n_simulations, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Draw four independent random sets from metapopulation</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set 1: 40 random points (group 1)</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    random_40_group1 <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">nrow</span>(dist_matrix), <span class="dv">40</span>)</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set 2: 40 different random points (target for group 1)</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>    remaining_indices <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(dist_matrix), random_40_group1)</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    random_40_target1 <span class="ot">&lt;-</span> <span class="fu">sample</span>(remaining_indices, <span class="dv">40</span>)</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set 3: 160 different random points (group 2)</span></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>    remaining_indices_2 <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(remaining_indices, random_40_target1)</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>    random_160_group2 <span class="ot">&lt;-</span> <span class="fu">sample</span>(remaining_indices_2, <span class="dv">160</span>)</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set 4: 40 fresh different random points (target for group 2)</span></span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>    remaining_indices_3 <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(remaining_indices_2, random_160_group2)</span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>    random_40_target2 <span class="ot">&lt;-</span> <span class="fu">sample</span>(remaining_indices_3, <span class="dv">40</span>)</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute distances: 40 random → 40 random target (set 1)</span></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>    group1_to_target_distances <span class="ot">&lt;-</span> <span class="fu">compute_sample_to_population_min_distances</span>(</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>      dist_matrix, random_40_group1, random_40_target1)</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute distances: 160 random → different 40 random target (set 2)</span></span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>    group2_to_target_distances <span class="ot">&lt;-</span> <span class="fu">compute_sample_to_population_min_distances</span>(</span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>      dist_matrix, random_160_group2, random_40_target2)</span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute Anderson-Darling statistic</span></span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(group1_to_target_distances) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(group2_to_target_distances) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>      ad_result <span class="ot">&lt;-</span> <span class="fu">ad.test</span>(group1_to_target_distances, group2_to_target_distances)</span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>      clean_null_ad_statistics[i] <span class="ot">&lt;-</span> ad_result<span class="sc">$</span>ad[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>      clean_null_ad_statistics[i] <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove any failed simulations</span></span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a>  clean_null_ad_statistics <span class="ot">&lt;-</span> clean_null_ad_statistics[<span class="sc">!</span><span class="fu">is.na</span>(clean_null_ad_statistics)]</span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Completed"</span>, <span class="fu">length</span>(clean_null_ad_statistics), <span class="st">"successful clean null simulations</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-51"><a href="#cb35-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(clean_null_ad_statistics)</span>
<span id="cb35-52"><a href="#cb35-52" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-53"><a href="#cb35-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-54"><a href="#cb35-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate the clean null distribution</span></span>
<span id="cb35-55"><a href="#cb35-55" aria-hidden="true" tabindex="-1"></a>clean_null_ad_distribution <span class="ot">&lt;-</span> <span class="fu">generate_clean_null_ad_distribution</span>(population_seqs, <span class="at">n_simulations =</span> <span class="dv">500</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Computing distance matrix for metapopulation...
Generating clean null distribution with 500 simulations...
Clean null simulation 50 of 500 
Clean null simulation 100 of 500 
Clean null simulation 150 of 500 
Clean null simulation 200 of 500 
Clean null simulation 250 of 500 
Clean null simulation 300 of 500 
Clean null simulation 350 of 500 
Clean null simulation 400 of 500 
Clean null simulation 450 of 500 
Clean null simulation 500 of 500 
Completed 500 successful clean null simulations</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare clean null vs original data split</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>comparison_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">AD_Statistic =</span> <span class="fu">c</span>(ad_distribution, clean_null_ad_distribution),</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">Distribution =</span> <span class="fu">factor</span>(<span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"Leave one out split 200"</span>, <span class="fu">length</span>(ad_distribution)),</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>                          <span class="fu">rep</span>(<span class="st">"Null all independent"</span>, <span class="fu">length</span>(clean_null_ad_distribution))))</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="compare-the-densities-of-the-500-random-splits-ad-to-the-null-generated-above" class="level3">
<h3 class="anchored" data-anchor-id="compare-the-densities-of-the-500-random-splits-ad-to-the-null-generated-above">Compare the densities of the 500 random splits AD to the null generated above</h3>
<p>This is the plot we show in the Figure.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create comparison plot</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>comparison_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(comparison_data, <span class="fu">aes</span>(<span class="at">x =</span> AD_Statistic, <span class="at">fill =</span> Distribution)) <span class="sc">+</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Leave one out split 200"</span> <span class="ot">=</span> <span class="st">"blue"</span>, </span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>                              <span class="st">"Null all independent"</span> <span class="ot">=</span> <span class="st">"red"</span>)) <span class="sc">+</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="co">#title = "Clean Comparison: Original Data Split vs Fully Independent Random Null",</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Anderson-Darling Statistic"</span>,</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Density"</span>,</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">"Distribution Type"</span>) <span class="sc">+</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(comparison_plot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="02-coincidence-detection_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Comparison: Original Data Split vs Fully Independent Random Null</figcaption>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary statistics comparison</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Clean Comparison (Fully Independent):</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Clean Comparison (Fully Independent):</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Original Data Split - Mean:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(ad_distribution), <span class="dv">4</span>), </span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">", Median:"</span>, <span class="fu">round</span>(<span class="fu">median</span>(ad_distribution), <span class="dv">4</span>), </span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">", 95th percentile:"</span>, <span class="fu">round</span>(<span class="fu">quantile</span>(ad_distribution, <span class="fl">0.95</span>), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Original Data Split - Mean: 1.5459 , Median: 1.2145 , 95th percentile: 3.8743 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Clean Null - Mean:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(clean_null_ad_distribution), <span class="dv">4</span>), </span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">", Median:"</span>, <span class="fu">round</span>(<span class="fu">median</span>(clean_null_ad_distribution), <span class="dv">4</span>), </span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">", 95th percentile:"</span>, <span class="fu">round</span>(<span class="fu">quantile</span>(clean_null_ad_distribution, <span class="fl">0.95</span>), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Clean Null - Mean: 1.4584 , Median: 1.0966 , 95th percentile: 3.7428 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate p-value</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>clean_null_95th <span class="ot">&lt;-</span> <span class="fu">quantile</span>(clean_null_ad_distribution, <span class="fl">0.95</span>)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>proportion_exceeding_clean_null <span class="ot">&lt;-</span> <span class="fu">mean</span>(ad_distribution <span class="sc">&gt;</span> clean_null_95th)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Proportion of original AD statistics exceeding clean null 95th percentile:"</span>, </span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(proportion_exceeding_clean_null, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Proportion of original AD statistics exceeding clean null 95th percentile: 0.054 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This gives you a clean p-value for testing population structure</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Estimated p-value for test:"</span>, <span class="fu">round</span>(proportion_exceeding_clean_null, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Estimated p-value for test: 0.054 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the comparison plot without the legend</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave("ad_fully_independent_comparison.png", comparison_plot_nt, width = 6, height = 4, dpi = 300)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="part-4-final-comparison-through-a-quantile-quantile-plot" class="level2">
<h2 class="anchored" data-anchor-id="part-4-final-comparison-through-a-quantile-quantile-plot">Part 4: Final Comparison through a quantile-quantile plot</h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare ad_distribution vs clean_null_ad_distribution</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create QQ plot data</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>qq_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">clean_null =</span> <span class="fu">sort</span>(clean_null_ad_distribution),</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">original_split =</span> <span class="fu">sort</span>(ad_distribution)</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Create QQ plot</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>qq_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(qq_data, <span class="fu">aes</span>(<span class="at">x =</span> clean_null, <span class="at">y =</span> original_split)) <span class="sc">+</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>,<span class="at">linewidth=</span><span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Null Distribution AD Quantiles"</span>,</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Data Split AD Quantiles"</span>) <span class="sc">+</span></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(qq_plot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="02-coincidence-detection_files/figure-html/final-comparison-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>QQ plot for AD with null on x axis and data split AD on y.</figcaption>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the QQ plot</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave("qq_plot_null_vs_original.png", qq_plot, width = 4, height = 4, dpi = 300)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb52" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Coincidence Detection using Distances: Simulations"</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Leave-one-out density comparisons and Anderson--Darling null distribution generation"</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="co">  message: false</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="co">  cache: false</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overview</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>This analysis implements coincidence detection methods using genetic distances computed with the leave one out method.</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a><span class="fu">## Setup</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup}</span></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-summary: "Load Libraries and Helper Functions"</span></span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a><span class="in">library(Biostrings)</span></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a><span class="in">library(ape)</span></span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a><span class="in">library(kSamples)</span></span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a><span class="in">library(ggplot2)</span></span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a><span class="in">library(gridExtra)</span></span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a><span class="in">set.seed(201123)  # For reproducibility</span></span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a><span class="in">```{r load_data}</span></span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a><span class="in"># Read the data</span></span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a><span class="in">aligned_seqs &lt;- readDNAStringSet("../data/silva_aligned_bacteria_sequences.fasta")</span></span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a><span class="in">cat("Loaded", length(aligned_seqs), "sequences\n")</span></span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a><span class="fu">## Part 1: Random Split Analysis</span></span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a>The original simulation with random 40/160 splits, we </span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a>generate <span class="in">`ad_distribution`</span> and make helper distance functions for</span>
<span id="cb52-37"><a href="#cb52-37" aria-hidden="true" tabindex="-1"></a>the splits.</span>
<span id="cb52-38"><a href="#cb52-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-39"><a href="#cb52-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-40"><a href="#cb52-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-41"><a href="#cb52-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-42"><a href="#cb52-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-43"><a href="#cb52-43" aria-hidden="true" tabindex="-1"></a><span class="in">```{r distancefunctions}</span></span>
<span id="cb52-44"><a href="#cb52-44" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb52-45"><a href="#cb52-45" aria-hidden="true" tabindex="-1"></a><span class="in"># Function to compute within-sample minimum distances (excluding self-distances)</span></span>
<span id="cb52-46"><a href="#cb52-46" aria-hidden="true" tabindex="-1"></a><span class="in">compute_within_sample_min_distances &lt;- function(dist_mat, sample_indices) {</span></span>
<span id="cb52-47"><a href="#cb52-47" aria-hidden="true" tabindex="-1"></a><span class="in">  sample_dist_mat &lt;- dist_mat[sample_indices, sample_indices]</span></span>
<span id="cb52-48"><a href="#cb52-48" aria-hidden="true" tabindex="-1"></a><span class="in">  min_distances &lt;- apply(sample_dist_mat, 1, function(row) {</span></span>
<span id="cb52-49"><a href="#cb52-49" aria-hidden="true" tabindex="-1"></a><span class="in">    non_zero_distances &lt;- row[row &gt; 0]  # Exclude self-distances (zeros)</span></span>
<span id="cb52-50"><a href="#cb52-50" aria-hidden="true" tabindex="-1"></a><span class="in">    if(length(non_zero_distances) &gt; 0) {</span></span>
<span id="cb52-51"><a href="#cb52-51" aria-hidden="true" tabindex="-1"></a><span class="in">      return(min(non_zero_distances))</span></span>
<span id="cb52-52"><a href="#cb52-52" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb52-53"><a href="#cb52-53" aria-hidden="true" tabindex="-1"></a><span class="in">      return(NA)</span></span>
<span id="cb52-54"><a href="#cb52-54" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb52-55"><a href="#cb52-55" aria-hidden="true" tabindex="-1"></a><span class="in">  })</span></span>
<span id="cb52-56"><a href="#cb52-56" aria-hidden="true" tabindex="-1"></a><span class="in">  return(min_distances[!is.na(min_distances)])  # Remove any NAs</span></span>
<span id="cb52-57"><a href="#cb52-57" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb52-58"><a href="#cb52-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-59"><a href="#cb52-59" aria-hidden="true" tabindex="-1"></a><span class="in"># Function to compute sample-to-population minimum distances</span></span>
<span id="cb52-60"><a href="#cb52-60" aria-hidden="true" tabindex="-1"></a><span class="in">compute_sample_to_population_min_distances &lt;- function(dist_mat, population_indices, sample_indices) {</span></span>
<span id="cb52-61"><a href="#cb52-61" aria-hidden="true" tabindex="-1"></a><span class="in">  # Distances from population to sample</span></span>
<span id="cb52-62"><a href="#cb52-62" aria-hidden="true" tabindex="-1"></a><span class="in">  pop_to_sample_dist_mat &lt;- dist_mat[population_indices, sample_indices]</span></span>
<span id="cb52-63"><a href="#cb52-63" aria-hidden="true" tabindex="-1"></a><span class="in">  min_distances &lt;- apply(pop_to_sample_dist_mat, 1, min)</span></span>
<span id="cb52-64"><a href="#cb52-64" aria-hidden="true" tabindex="-1"></a><span class="in">  return(min_distances)</span></span>
<span id="cb52-65"><a href="#cb52-65" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb52-66"><a href="#cb52-66" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-67"><a href="#cb52-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-68"><a href="#cb52-68" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mainsimulation}</span></span>
<span id="cb52-69"><a href="#cb52-69" aria-hidden="true" tabindex="-1"></a><span class="in"># Main simulation function</span></span>
<span id="cb52-70"><a href="#cb52-70" aria-hidden="true" tabindex="-1"></a><span class="in">simulate_ad_statistics &lt;- function(seqs, n_simulations = 500) {</span></span>
<span id="cb52-71"><a href="#cb52-71" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute distance matrix once</span></span>
<span id="cb52-72"><a href="#cb52-72" aria-hidden="true" tabindex="-1"></a><span class="in">  cat("Computing distance matrix...\n")</span></span>
<span id="cb52-73"><a href="#cb52-73" aria-hidden="true" tabindex="-1"></a><span class="in">  dist_matrix &lt;- as.matrix(dist.dna(as.DNAbin(seqs), model = "K80", pairwise.deletion = TRUE))</span></span>
<span id="cb52-74"><a href="#cb52-74" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb52-75"><a href="#cb52-75" aria-hidden="true" tabindex="-1"></a><span class="in">  ad_statistics &lt;- numeric(n_simulations)</span></span>
<span id="cb52-76"><a href="#cb52-76" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb52-77"><a href="#cb52-77" aria-hidden="true" tabindex="-1"></a><span class="in">  cat("Running", n_simulations, "simulations...\n")</span></span>
<span id="cb52-78"><a href="#cb52-78" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb52-79"><a href="#cb52-79" aria-hidden="true" tabindex="-1"></a><span class="in">  for(i in 1:n_simulations) {</span></span>
<span id="cb52-80"><a href="#cb52-80" aria-hidden="true" tabindex="-1"></a><span class="in">    if(i %% 50 == 0) cat("Simulation", i, "of", n_simulations, "\n")</span></span>
<span id="cb52-81"><a href="#cb52-81" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb52-82"><a href="#cb52-82" aria-hidden="true" tabindex="-1"></a><span class="in">    # Randomly split 200 sequences into sample (40) and population (160)</span></span>
<span id="cb52-83"><a href="#cb52-83" aria-hidden="true" tabindex="-1"></a><span class="in">    random_indices &lt;- sample(nrow(dist_matrix), 200)</span></span>
<span id="cb52-84"><a href="#cb52-84" aria-hidden="true" tabindex="-1"></a><span class="in">    sample_indices &lt;- random_indices[1:40]</span></span>
<span id="cb52-85"><a href="#cb52-85" aria-hidden="true" tabindex="-1"></a><span class="in">    population_indices &lt;- random_indices[41:200]</span></span>
<span id="cb52-86"><a href="#cb52-86" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb52-87"><a href="#cb52-87" aria-hidden="true" tabindex="-1"></a><span class="in">    # Compute within-sample minimum distances (n1 = up to 40, but typically 39 per point in this part)</span></span>
<span id="cb52-88"><a href="#cb52-88" aria-hidden="true" tabindex="-1"></a><span class="in">    within_sample_distances &lt;- compute_within_sample_min_distances(dist_matrix, sample_indices)</span></span>
<span id="cb52-89"><a href="#cb52-89" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb52-90"><a href="#cb52-90" aria-hidden="true" tabindex="-1"></a><span class="in">    # Compute sample-to-population minimum distances (n2 = 160)</span></span>
<span id="cb52-91"><a href="#cb52-91" aria-hidden="true" tabindex="-1"></a><span class="in">    sample_to_pop_distances &lt;- compute_sample_to_population_min_distances(dist_matrix, population_indices, sample_indices)</span></span>
<span id="cb52-92"><a href="#cb52-92" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb52-93"><a href="#cb52-93" aria-hidden="true" tabindex="-1"></a><span class="in">    # Compute Anderson-Darling statistic</span></span>
<span id="cb52-94"><a href="#cb52-94" aria-hidden="true" tabindex="-1"></a><span class="in">    if(length(within_sample_distances) &gt; 0 &amp;&amp; length(sample_to_pop_distances) &gt; 0) {</span></span>
<span id="cb52-95"><a href="#cb52-95" aria-hidden="true" tabindex="-1"></a><span class="in">      ad_result &lt;- ad.test(within_sample_distances, sample_to_pop_distances)</span></span>
<span id="cb52-96"><a href="#cb52-96" aria-hidden="true" tabindex="-1"></a><span class="in">      ad_statistics[i] &lt;- ad_result$ad[1, 1]</span></span>
<span id="cb52-97"><a href="#cb52-97" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb52-98"><a href="#cb52-98" aria-hidden="true" tabindex="-1"></a><span class="in">      ad_statistics[i] &lt;- NA</span></span>
<span id="cb52-99"><a href="#cb52-99" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb52-100"><a href="#cb52-100" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb52-101"><a href="#cb52-101" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb52-102"><a href="#cb52-102" aria-hidden="true" tabindex="-1"></a><span class="in">  # Remove any failed simulations</span></span>
<span id="cb52-103"><a href="#cb52-103" aria-hidden="true" tabindex="-1"></a><span class="in">  ad_statistics &lt;- ad_statistics[!is.na(ad_statistics)]</span></span>
<span id="cb52-104"><a href="#cb52-104" aria-hidden="true" tabindex="-1"></a><span class="in">  cat("Completed", length(ad_statistics), "successful simulations\n")</span></span>
<span id="cb52-105"><a href="#cb52-105" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb52-106"><a href="#cb52-106" aria-hidden="true" tabindex="-1"></a><span class="in">  return(ad_statistics)</span></span>
<span id="cb52-107"><a href="#cb52-107" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb52-108"><a href="#cb52-108" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-109"><a href="#cb52-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-110"><a href="#cb52-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-111"><a href="#cb52-111" aria-hidden="true" tabindex="-1"></a><span class="in">```{r runsimulationsplits}</span></span>
<span id="cb52-112"><a href="#cb52-112" aria-hidden="true" tabindex="-1"></a><span class="in"># Run the simulations</span></span>
<span id="cb52-113"><a href="#cb52-113" aria-hidden="true" tabindex="-1"></a><span class="in"># This was the original one </span></span>
<span id="cb52-114"><a href="#cb52-114" aria-hidden="true" tabindex="-1"></a><span class="in">ad_distribution &lt;- simulate_ad_statistics(aligned_seqs, n_simulations = 500)</span></span>
<span id="cb52-115"><a href="#cb52-115" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-116"><a href="#cb52-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-117"><a href="#cb52-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-118"><a href="#cb52-118" aria-hidden="true" tabindex="-1"></a><span class="fu">## Part 2: Distance Distributions Comparison  and AD computation</span></span>
<span id="cb52-119"><a href="#cb52-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-120"><a href="#cb52-120" aria-hidden="true" tabindex="-1"></a>Here we are using our distance between and within functions to </span>
<span id="cb52-121"><a href="#cb52-121" aria-hidden="true" tabindex="-1"></a>compare the leave one out for 40 point to the "true" distance computation for 160.</span>
<span id="cb52-122"><a href="#cb52-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-123"><a href="#cb52-123" aria-hidden="true" tabindex="-1"></a><span class="in">```{r distance-comparisons}</span></span>
<span id="cb52-124"><a href="#cb52-124" aria-hidden="true" tabindex="-1"></a><span class="in"># The 4 selected simulations with density plots</span></span>
<span id="cb52-125"><a href="#cb52-125" aria-hidden="true" tabindex="-1"></a><span class="in"># Show within-sample vs sample-to-population distances</span></span>
<span id="cb52-126"><a href="#cb52-126" aria-hidden="true" tabindex="-1"></a><span class="in"># Save distance distributions for selected simulations</span></span>
<span id="cb52-127"><a href="#cb52-127" aria-hidden="true" tabindex="-1"></a><span class="in">simulate_ad_statistics_with_distances &lt;- function(seqs, n_simulations = 500, save_simulations = c(150, 200, 250, 450)) {</span></span>
<span id="cb52-128"><a href="#cb52-128" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute distance matrix once</span></span>
<span id="cb52-129"><a href="#cb52-129" aria-hidden="true" tabindex="-1"></a><span class="in">  cat("Computing distance matrix...\n")</span></span>
<span id="cb52-130"><a href="#cb52-130" aria-hidden="true" tabindex="-1"></a><span class="in">  dist_matrix &lt;- as.matrix(dist.dna(as.DNAbin(seqs), model = "K80", pairwise.deletion = TRUE))</span></span>
<span id="cb52-131"><a href="#cb52-131" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb52-132"><a href="#cb52-132" aria-hidden="true" tabindex="-1"></a><span class="in">  ad_statistics &lt;- numeric(n_simulations)</span></span>
<span id="cb52-133"><a href="#cb52-133" aria-hidden="true" tabindex="-1"></a><span class="in">  saved_distances &lt;- list()</span></span>
<span id="cb52-134"><a href="#cb52-134" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb52-135"><a href="#cb52-135" aria-hidden="true" tabindex="-1"></a><span class="in">  cat("Running", n_simulations, "simulations...\n")</span></span>
<span id="cb52-136"><a href="#cb52-136" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb52-137"><a href="#cb52-137" aria-hidden="true" tabindex="-1"></a><span class="in">  for(i in 1:n_simulations) {</span></span>
<span id="cb52-138"><a href="#cb52-138" aria-hidden="true" tabindex="-1"></a><span class="in">    if(i %% 50 == 0) cat("Simulation", i, "of", n_simulations, "\n")</span></span>
<span id="cb52-139"><a href="#cb52-139" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb52-140"><a href="#cb52-140" aria-hidden="true" tabindex="-1"></a><span class="in">    # Randomly split 200 sequences into sample (40) and population (160)</span></span>
<span id="cb52-141"><a href="#cb52-141" aria-hidden="true" tabindex="-1"></a><span class="in">    random_indices &lt;- sample(nrow(dist_matrix), 200)</span></span>
<span id="cb52-142"><a href="#cb52-142" aria-hidden="true" tabindex="-1"></a><span class="in">    sample_indices &lt;- random_indices[1:40]</span></span>
<span id="cb52-143"><a href="#cb52-143" aria-hidden="true" tabindex="-1"></a><span class="in">    population_indices &lt;- random_indices[41:200]</span></span>
<span id="cb52-144"><a href="#cb52-144" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb52-145"><a href="#cb52-145" aria-hidden="true" tabindex="-1"></a><span class="in">    # Compute within-sample minimum distances (n1 = up to 40, but typically 39 per point)</span></span>
<span id="cb52-146"><a href="#cb52-146" aria-hidden="true" tabindex="-1"></a><span class="in">    within_sample_distances &lt;- compute_within_sample_min_distances(dist_matrix, sample_indices)</span></span>
<span id="cb52-147"><a href="#cb52-147" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb52-148"><a href="#cb52-148" aria-hidden="true" tabindex="-1"></a><span class="in">    # Compute sample-to-population minimum distances (n2 = 160)</span></span>
<span id="cb52-149"><a href="#cb52-149" aria-hidden="true" tabindex="-1"></a><span class="in">    sample_to_pop_distances &lt;- compute_sample_to_population_min_distances(dist_matrix, population_indices, sample_indices)</span></span>
<span id="cb52-150"><a href="#cb52-150" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb52-151"><a href="#cb52-151" aria-hidden="true" tabindex="-1"></a><span class="in">    # Save distances for selected simulations</span></span>
<span id="cb52-152"><a href="#cb52-152" aria-hidden="true" tabindex="-1"></a><span class="in">    if(i %in% save_simulations) {</span></span>
<span id="cb52-153"><a href="#cb52-153" aria-hidden="true" tabindex="-1"></a><span class="in">      saved_distances[[as.character(i)]] &lt;- list(</span></span>
<span id="cb52-154"><a href="#cb52-154" aria-hidden="true" tabindex="-1"></a><span class="in">        within_sample = within_sample_distances,</span></span>
<span id="cb52-155"><a href="#cb52-155" aria-hidden="true" tabindex="-1"></a><span class="in">        sample_to_pop = sample_to_pop_distances</span></span>
<span id="cb52-156"><a href="#cb52-156" aria-hidden="true" tabindex="-1"></a><span class="in">      )</span></span>
<span id="cb52-157"><a href="#cb52-157" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb52-158"><a href="#cb52-158" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb52-159"><a href="#cb52-159" aria-hidden="true" tabindex="-1"></a><span class="in">    # Compute Anderson-Darling statistic</span></span>
<span id="cb52-160"><a href="#cb52-160" aria-hidden="true" tabindex="-1"></a><span class="in">    if(length(within_sample_distances) &gt; 0 &amp;&amp; length(sample_to_pop_distances) &gt; 0) {</span></span>
<span id="cb52-161"><a href="#cb52-161" aria-hidden="true" tabindex="-1"></a><span class="in">      ad_result &lt;- ad.test(within_sample_distances, sample_to_pop_distances)</span></span>
<span id="cb52-162"><a href="#cb52-162" aria-hidden="true" tabindex="-1"></a><span class="in">      ad_statistics[i] &lt;- ad_result$ad[1, 1]</span></span>
<span id="cb52-163"><a href="#cb52-163" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb52-164"><a href="#cb52-164" aria-hidden="true" tabindex="-1"></a><span class="in">      ad_statistics[i] &lt;- NA</span></span>
<span id="cb52-165"><a href="#cb52-165" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb52-166"><a href="#cb52-166" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb52-167"><a href="#cb52-167" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb52-168"><a href="#cb52-168" aria-hidden="true" tabindex="-1"></a><span class="in">  # Remove any failed simulations</span></span>
<span id="cb52-169"><a href="#cb52-169" aria-hidden="true" tabindex="-1"></a><span class="in">  ad_statistics &lt;- ad_statistics[!is.na(ad_statistics)]</span></span>
<span id="cb52-170"><a href="#cb52-170" aria-hidden="true" tabindex="-1"></a><span class="in">  cat("Completed", length(ad_statistics), "successful simulations\n")</span></span>
<span id="cb52-171"><a href="#cb52-171" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb52-172"><a href="#cb52-172" aria-hidden="true" tabindex="-1"></a><span class="in">  return(list(ad_statistics = ad_statistics, saved_distances = saved_distances))</span></span>
<span id="cb52-173"><a href="#cb52-173" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb52-174"><a href="#cb52-174" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-175"><a href="#cb52-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-178"><a href="#cb52-178" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-179"><a href="#cb52-179" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the simulations with distance saving</span></span>
<span id="cb52-180"><a href="#cb52-180" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">simulate_ad_statistics_with_distances</span>(aligned_seqs, <span class="at">n_simulations =</span> <span class="dv">500</span>, </span>
<span id="cb52-181"><a href="#cb52-181" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">save_simulations =</span> <span class="fu">c</span>(<span class="dv">150</span>, <span class="dv">200</span>, <span class="dv">250</span>, <span class="dv">450</span>))</span>
<span id="cb52-182"><a href="#cb52-182" aria-hidden="true" tabindex="-1"></a>ad_distribution <span class="ot">&lt;-</span> results<span class="sc">$</span>ad_statistics</span>
<span id="cb52-183"><a href="#cb52-183" aria-hidden="true" tabindex="-1"></a>saved_distances <span class="ot">&lt;-</span> results<span class="sc">$</span>saved_distances</span>
<span id="cb52-184"><a href="#cb52-184" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-185"><a href="#cb52-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-186"><a href="#cb52-186" aria-hidden="true" tabindex="-1"></a><span class="fu">### Plots comparing four of the distance pairs for Figure 7a</span></span>
<span id="cb52-187"><a href="#cb52-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-188"><a href="#cb52-188" aria-hidden="true" tabindex="-1"></a>Make the comparison densities and the Anderson -- Darling histogram for the 500</span>
<span id="cb52-189"><a href="#cb52-189" aria-hidden="true" tabindex="-1"></a>simulations of splits.</span>
<span id="cb52-190"><a href="#cb52-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-191"><a href="#cb52-191" aria-hidden="true" tabindex="-1"></a><span class="in">```{r simul4}</span></span>
<span id="cb52-192"><a href="#cb52-192" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: "Four exemplary simulations and the two densities compared."</span></span>
<span id="cb52-193"><a href="#cb52-193" aria-hidden="true" tabindex="-1"></a><span class="in"># Create density plots for the 4 selected simulations</span></span>
<span id="cb52-194"><a href="#cb52-194" aria-hidden="true" tabindex="-1"></a><span class="in">library(gridExtra)</span></span>
<span id="cb52-195"><a href="#cb52-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-196"><a href="#cb52-196" aria-hidden="true" tabindex="-1"></a><span class="in">density_plots &lt;- list()</span></span>
<span id="cb52-197"><a href="#cb52-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-198"><a href="#cb52-198" aria-hidden="true" tabindex="-1"></a><span class="in">for(i in 1:length(saved_distances)) {</span></span>
<span id="cb52-199"><a href="#cb52-199" aria-hidden="true" tabindex="-1"></a><span class="in">  sim_num &lt;- names(saved_distances)[i]</span></span>
<span id="cb52-200"><a href="#cb52-200" aria-hidden="true" tabindex="-1"></a><span class="in">  within_dist &lt;- saved_distances[[sim_num]]$within_sample</span></span>
<span id="cb52-201"><a href="#cb52-201" aria-hidden="true" tabindex="-1"></a><span class="in">  between_dist &lt;- saved_distances[[sim_num]]$sample_to_pop</span></span>
<span id="cb52-202"><a href="#cb52-202" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb52-203"><a href="#cb52-203" aria-hidden="true" tabindex="-1"></a><span class="in">  # Create combined data frame</span></span>
<span id="cb52-204"><a href="#cb52-204" aria-hidden="true" tabindex="-1"></a><span class="in">  plot_data &lt;- data.frame(</span></span>
<span id="cb52-205"><a href="#cb52-205" aria-hidden="true" tabindex="-1"></a><span class="in">    distance = c(within_dist, between_dist),</span></span>
<span id="cb52-206"><a href="#cb52-206" aria-hidden="true" tabindex="-1"></a><span class="in">    type = factor(c(rep("Within-Sample", length(within_dist)), </span></span>
<span id="cb52-207"><a href="#cb52-207" aria-hidden="true" tabindex="-1"></a><span class="in">                    rep("Sample-to-Population", length(between_dist))))</span></span>
<span id="cb52-208"><a href="#cb52-208" aria-hidden="true" tabindex="-1"></a><span class="in">  )</span></span>
<span id="cb52-209"><a href="#cb52-209" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb52-210"><a href="#cb52-210" aria-hidden="true" tabindex="-1"></a><span class="in">  # Calculate AD statistic for this simulation</span></span>
<span id="cb52-211"><a href="#cb52-211" aria-hidden="true" tabindex="-1"></a><span class="in">  ad_stat &lt;- round(ad_distribution[as.numeric(sim_num)], 3)</span></span>
<span id="cb52-212"><a href="#cb52-212" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb52-213"><a href="#cb52-213" aria-hidden="true" tabindex="-1"></a><span class="in">  density_plots[[i]] &lt;- ggplot(plot_data, aes(x = distance, fill = type)) +</span></span>
<span id="cb52-214"><a href="#cb52-214" aria-hidden="true" tabindex="-1"></a><span class="in">    geom_density(alpha = 0.6) +</span></span>
<span id="cb52-215"><a href="#cb52-215" aria-hidden="true" tabindex="-1"></a><span class="in">    scale_fill_manual(values = c("Within-Sample" = "blue", "Sample-to-Population" = "red")) +</span></span>
<span id="cb52-216"><a href="#cb52-216" aria-hidden="true" tabindex="-1"></a><span class="in">    labs(#title = paste("Simulation", sim_num, "- AD =", ad_stat),</span></span>
<span id="cb52-217"><a href="#cb52-217" aria-hidden="true" tabindex="-1"></a><span class="in">         x = "Minimum Distance",</span></span>
<span id="cb52-218"><a href="#cb52-218" aria-hidden="true" tabindex="-1"></a><span class="in">         y = "Density",</span></span>
<span id="cb52-219"><a href="#cb52-219" aria-hidden="true" tabindex="-1"></a><span class="in">         fill = "Distance Type") +</span></span>
<span id="cb52-220"><a href="#cb52-220" aria-hidden="true" tabindex="-1"></a><span class="in">    theme_minimal() +</span></span>
<span id="cb52-221"><a href="#cb52-221" aria-hidden="true" tabindex="-1"></a><span class="in">    theme(legend.position = "none")</span></span>
<span id="cb52-222"><a href="#cb52-222" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb52-223"><a href="#cb52-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-224"><a href="#cb52-224" aria-hidden="true" tabindex="-1"></a><span class="in"># Arrange the 4 density plots in a 2x2 grid</span></span>
<span id="cb52-225"><a href="#cb52-225" aria-hidden="true" tabindex="-1"></a><span class="in">combined_density_plot &lt;- grid.arrange(density_plots[[1]], density_plots[[2]], </span></span>
<span id="cb52-226"><a href="#cb52-226" aria-hidden="true" tabindex="-1"></a><span class="in">                                     density_plots[[3]], density_plots[[4]], </span></span>
<span id="cb52-227"><a href="#cb52-227" aria-hidden="true" tabindex="-1"></a><span class="in">                                     ncol = 2, nrow = 2)</span></span>
<span id="cb52-228"><a href="#cb52-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-229"><a href="#cb52-229" aria-hidden="true" tabindex="-1"></a><span class="in">combined_density_plot</span></span>
<span id="cb52-230"><a href="#cb52-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-231"><a href="#cb52-231" aria-hidden="true" tabindex="-1"></a><span class="in"># Save the combined plot for Figure left side</span></span>
<span id="cb52-232"><a href="#cb52-232" aria-hidden="true" tabindex="-1"></a><span class="in"># ggsave("four_density_comparisons.png", combined_density_plot, width = 4, height = 4, dpi = 300)</span></span>
<span id="cb52-233"><a href="#cb52-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-234"><a href="#cb52-234" aria-hidden="true" tabindex="-1"></a><span class="in"># Summary statistics</span></span>
<span id="cb52-235"><a href="#cb52-235" aria-hidden="true" tabindex="-1"></a><span class="in">cat("\nSummary of AD Statistics:\n")</span></span>
<span id="cb52-236"><a href="#cb52-236" aria-hidden="true" tabindex="-1"></a><span class="in">cat("Mean:", mean(ad_distribution), "\n")</span></span>
<span id="cb52-237"><a href="#cb52-237" aria-hidden="true" tabindex="-1"></a><span class="in">cat("Median:", median(ad_distribution), "\n")</span></span>
<span id="cb52-238"><a href="#cb52-238" aria-hidden="true" tabindex="-1"></a><span class="in">cat("95th Percentile:", quantile(ad_distribution, 0.95), "\n")</span></span>
<span id="cb52-239"><a href="#cb52-239" aria-hidden="true" tabindex="-1"></a><span class="in">cat("Standard Deviation:", sd(ad_distribution), "\n")</span></span>
<span id="cb52-240"><a href="#cb52-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-241"><a href="#cb52-241" aria-hidden="true" tabindex="-1"></a><span class="in"># Print AD statistics for the selected simulations</span></span>
<span id="cb52-242"><a href="#cb52-242" aria-hidden="true" tabindex="-1"></a><span class="in">cat("\nAD Statistics for selected simulations:\n")</span></span>
<span id="cb52-243"><a href="#cb52-243" aria-hidden="true" tabindex="-1"></a><span class="in">for(sim_num in names(saved_distances)) {</span></span>
<span id="cb52-244"><a href="#cb52-244" aria-hidden="true" tabindex="-1"></a><span class="in">  cat("Simulation", sim_num, ": AD =", round(ad_distribution[as.numeric(sim_num)], 4), "\n")</span></span>
<span id="cb52-245"><a href="#cb52-245" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb52-246"><a href="#cb52-246" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-247"><a href="#cb52-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-248"><a href="#cb52-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-249"><a href="#cb52-249" aria-hidden="true" tabindex="-1"></a><span class="fu">### Histogram of Anderson --Darling 500 stats for 7b</span></span>
<span id="cb52-250"><a href="#cb52-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-251"><a href="#cb52-251" aria-hidden="true" tabindex="-1"></a><span class="in">```{r hist7b}</span></span>
<span id="cb52-252"><a href="#cb52-252" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: "Histogram of the 500 Anderson--Statistic comparing the 40 LOO distances and the 160 sample to population ones."</span></span>
<span id="cb52-253"><a href="#cb52-253" aria-hidden="true" tabindex="-1"></a><span class="in"># Create the  histogram for Figure 7b, no title </span></span>
<span id="cb52-254"><a href="#cb52-254" aria-hidden="true" tabindex="-1"></a><span class="in">hist_plot_nt &lt;- ggplot(data.frame(ad_statistic = ad_distribution), aes(x = ad_statistic)) +</span></span>
<span id="cb52-255"><a href="#cb52-255" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_histogram(binwidth = 0.2, fill = "lightblue", color = "darkblue", alpha = 0.7) +</span></span>
<span id="cb52-256"><a href="#cb52-256" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(aes(xintercept = median(ad_statistic)), color = "darkblue", linetype = "dashed", size = 1) +</span></span>
<span id="cb52-257"><a href="#cb52-257" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_vline(aes(xintercept = quantile(ad_statistic, 0.95)), color = "purple", linetype = "dashed", size = 1) +</span></span>
<span id="cb52-258"><a href="#cb52-258" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Anderson-Darling Statistic",</span></span>
<span id="cb52-259"><a href="#cb52-259" aria-hidden="true" tabindex="-1"></a><span class="in">       y = "Frequency") +</span></span>
<span id="cb52-260"><a href="#cb52-260" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_minimal() +</span></span>
<span id="cb52-261"><a href="#cb52-261" aria-hidden="true" tabindex="-1"></a><span class="in">  annotate("text", x = median(ad_distribution)+0.6, y = 60, </span></span>
<span id="cb52-262"><a href="#cb52-262" aria-hidden="true" tabindex="-1"></a><span class="in">           label = paste("Median =", round(median(ad_distribution), 2)), vjust = 1, color = "darkblue") +</span></span>
<span id="cb52-263"><a href="#cb52-263" aria-hidden="true" tabindex="-1"></a><span class="in">  annotate("text", x = quantile(ad_distribution, 0.95), y = max(table(cut(ad_distribution, breaks = 20)))*0.1, </span></span>
<span id="cb52-264"><a href="#cb52-264" aria-hidden="true" tabindex="-1"></a><span class="in">           label = paste("95th % =", round(quantile(ad_distribution, 0.95), 2)), vjust = -1, color = "purple")</span></span>
<span id="cb52-265"><a href="#cb52-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-266"><a href="#cb52-266" aria-hidden="true" tabindex="-1"></a><span class="in">print(hist_plot_nt)</span></span>
<span id="cb52-267"><a href="#cb52-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-268"><a href="#cb52-268" aria-hidden="true" tabindex="-1"></a><span class="in"># ggsave("ADhistogram.png",hist_plot_nt,width=5,height=4)</span></span>
<span id="cb52-269"><a href="#cb52-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-270"><a href="#cb52-270" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-271"><a href="#cb52-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-272"><a href="#cb52-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-273"><a href="#cb52-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-274"><a href="#cb52-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-275"><a href="#cb52-275" aria-hidden="true" tabindex="-1"></a><span class="fu">## Part 3: Null Distribution of Anderson--Darling : Generation</span></span>
<span id="cb52-276"><a href="#cb52-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-277"><a href="#cb52-277" aria-hidden="true" tabindex="-1"></a><span class="in">```{r null-generation}</span></span>
<span id="cb52-278"><a href="#cb52-278" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb52-279"><a href="#cb52-279" aria-hidden="true" tabindex="-1"></a><span class="in"># Bootstrap + mutate to create 1000-sequence population</span></span>
<span id="cb52-280"><a href="#cb52-280" aria-hidden="true" tabindex="-1"></a><span class="in"># Function to bootstrap and mutate sequences (your existing code)</span></span>
<span id="cb52-281"><a href="#cb52-281" aria-hidden="true" tabindex="-1"></a><span class="in">bootstrap_and_mutate_sequences &lt;- function(seqs, n, mutation_rate = 0.01) {</span></span>
<span id="cb52-282"><a href="#cb52-282" aria-hidden="true" tabindex="-1"></a><span class="in">  bootstrapped_seqs &lt;- sample(seqs, n, replace = TRUE)</span></span>
<span id="cb52-283"><a href="#cb52-283" aria-hidden="true" tabindex="-1"></a><span class="in">  mutated_seqs &lt;- sapply(bootstrapped_seqs, function(seq) {</span></span>
<span id="cb52-284"><a href="#cb52-284" aria-hidden="true" tabindex="-1"></a><span class="in">    seq_vector &lt;- strsplit(as.character(seq), "")[[1]]</span></span>
<span id="cb52-285"><a href="#cb52-285" aria-hidden="true" tabindex="-1"></a><span class="in">    mutation_sites &lt;- which(runif(length(seq_vector)) &lt; mutation_rate)</span></span>
<span id="cb52-286"><a href="#cb52-286" aria-hidden="true" tabindex="-1"></a><span class="in">    seq_vector[mutation_sites] &lt;- sample(c("A", "C", "G", "T"), length(mutation_sites), replace = TRUE)</span></span>
<span id="cb52-287"><a href="#cb52-287" aria-hidden="true" tabindex="-1"></a><span class="in">    paste(seq_vector, collapse = "")</span></span>
<span id="cb52-288"><a href="#cb52-288" aria-hidden="true" tabindex="-1"></a><span class="in">  })</span></span>
<span id="cb52-289"><a href="#cb52-289" aria-hidden="true" tabindex="-1"></a><span class="in">  return(DNAStringSet(mutated_seqs))</span></span>
<span id="cb52-290"><a href="#cb52-290" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb52-291"><a href="#cb52-291" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-292"><a href="#cb52-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-293"><a href="#cb52-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-294"><a href="#cb52-294" aria-hidden="true" tabindex="-1"></a><span class="fu">### Create metapopulation</span></span>
<span id="cb52-295"><a href="#cb52-295" aria-hidden="true" tabindex="-1"></a><span class="in">```{r metapop}</span></span>
<span id="cb52-296"><a href="#cb52-296" aria-hidden="true" tabindex="-1"></a><span class="in">population_size &lt;- 1000</span></span>
<span id="cb52-297"><a href="#cb52-297" aria-hidden="true" tabindex="-1"></a><span class="in">cat("Creating metapopulation of", population_size, "sequences...\n")</span></span>
<span id="cb52-298"><a href="#cb52-298" aria-hidden="true" tabindex="-1"></a><span class="in">population_seqs &lt;- bootstrap_and_mutate_sequences(aligned_seqs, population_size, mutation_rate = 0.01)</span></span>
<span id="cb52-299"><a href="#cb52-299" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-300"><a href="#cb52-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-301"><a href="#cb52-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-302"><a href="#cb52-302" aria-hidden="true" tabindex="-1"></a><span class="fu">### Generate clean_null_ad_distribution with independent samples</span></span>
<span id="cb52-303"><a href="#cb52-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-304"><a href="#cb52-304" aria-hidden="true" tabindex="-1"></a>Null from 40 random to 40 random and 160 random to 40 random</span>
<span id="cb52-305"><a href="#cb52-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-306"><a href="#cb52-306" aria-hidden="true" tabindex="-1"></a><span class="in">```{r generatenull}</span></span>
<span id="cb52-307"><a href="#cb52-307" aria-hidden="true" tabindex="-1"></a><span class="in">#| code-fold: true</span></span>
<span id="cb52-308"><a href="#cb52-308" aria-hidden="true" tabindex="-1"></a><span class="in"># Function to generate the clean null distribution (all independent random sets)</span></span>
<span id="cb52-309"><a href="#cb52-309" aria-hidden="true" tabindex="-1"></a><span class="in">generate_clean_null_ad_distribution &lt;- function(metapopulation_seqs, n_simulations = 500) {</span></span>
<span id="cb52-310"><a href="#cb52-310" aria-hidden="true" tabindex="-1"></a><span class="in">  # Compute distance matrix for the entire metapopulation once</span></span>
<span id="cb52-311"><a href="#cb52-311" aria-hidden="true" tabindex="-1"></a><span class="in">  cat("Computing distance matrix for metapopulation...\n")</span></span>
<span id="cb52-312"><a href="#cb52-312" aria-hidden="true" tabindex="-1"></a><span class="in">  dist_matrix &lt;- as.matrix(dist.dna(as.DNAbin(metapopulation_seqs), model = "K80", pairwise.deletion = TRUE))</span></span>
<span id="cb52-313"><a href="#cb52-313" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb52-314"><a href="#cb52-314" aria-hidden="true" tabindex="-1"></a><span class="in">  clean_null_ad_statistics &lt;- numeric(n_simulations)</span></span>
<span id="cb52-315"><a href="#cb52-315" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb52-316"><a href="#cb52-316" aria-hidden="true" tabindex="-1"></a><span class="in">  cat("Generating clean null distribution with", n_simulations, "simulations...\n")</span></span>
<span id="cb52-317"><a href="#cb52-317" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb52-318"><a href="#cb52-318" aria-hidden="true" tabindex="-1"></a><span class="in">  for(i in 1:n_simulations) {</span></span>
<span id="cb52-319"><a href="#cb52-319" aria-hidden="true" tabindex="-1"></a><span class="in">    if(i %% 50 == 0) cat("Clean null simulation", i, "of", n_simulations, "\n")</span></span>
<span id="cb52-320"><a href="#cb52-320" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb52-321"><a href="#cb52-321" aria-hidden="true" tabindex="-1"></a><span class="in">    # Draw four independent random sets from metapopulation</span></span>
<span id="cb52-322"><a href="#cb52-322" aria-hidden="true" tabindex="-1"></a><span class="in">    # Set 1: 40 random points (group 1)</span></span>
<span id="cb52-323"><a href="#cb52-323" aria-hidden="true" tabindex="-1"></a><span class="in">    random_40_group1 &lt;- sample(nrow(dist_matrix), 40)</span></span>
<span id="cb52-324"><a href="#cb52-324" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb52-325"><a href="#cb52-325" aria-hidden="true" tabindex="-1"></a><span class="in">    # Set 2: 40 different random points (target for group 1)</span></span>
<span id="cb52-326"><a href="#cb52-326" aria-hidden="true" tabindex="-1"></a><span class="in">    remaining_indices &lt;- setdiff(1:nrow(dist_matrix), random_40_group1)</span></span>
<span id="cb52-327"><a href="#cb52-327" aria-hidden="true" tabindex="-1"></a><span class="in">    random_40_target1 &lt;- sample(remaining_indices, 40)</span></span>
<span id="cb52-328"><a href="#cb52-328" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb52-329"><a href="#cb52-329" aria-hidden="true" tabindex="-1"></a><span class="in">    # Set 3: 160 different random points (group 2)</span></span>
<span id="cb52-330"><a href="#cb52-330" aria-hidden="true" tabindex="-1"></a><span class="in">    remaining_indices_2 &lt;- setdiff(remaining_indices, random_40_target1)</span></span>
<span id="cb52-331"><a href="#cb52-331" aria-hidden="true" tabindex="-1"></a><span class="in">    random_160_group2 &lt;- sample(remaining_indices_2, 160)</span></span>
<span id="cb52-332"><a href="#cb52-332" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb52-333"><a href="#cb52-333" aria-hidden="true" tabindex="-1"></a><span class="in">    # Set 4: 40 fresh different random points (target for group 2)</span></span>
<span id="cb52-334"><a href="#cb52-334" aria-hidden="true" tabindex="-1"></a><span class="in">    remaining_indices_3 &lt;- setdiff(remaining_indices_2, random_160_group2)</span></span>
<span id="cb52-335"><a href="#cb52-335" aria-hidden="true" tabindex="-1"></a><span class="in">    random_40_target2 &lt;- sample(remaining_indices_3, 40)</span></span>
<span id="cb52-336"><a href="#cb52-336" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb52-337"><a href="#cb52-337" aria-hidden="true" tabindex="-1"></a><span class="in">    # Compute distances: 40 random → 40 random target (set 1)</span></span>
<span id="cb52-338"><a href="#cb52-338" aria-hidden="true" tabindex="-1"></a><span class="in">    group1_to_target_distances &lt;- compute_sample_to_population_min_distances(</span></span>
<span id="cb52-339"><a href="#cb52-339" aria-hidden="true" tabindex="-1"></a><span class="in">      dist_matrix, random_40_group1, random_40_target1)</span></span>
<span id="cb52-340"><a href="#cb52-340" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb52-341"><a href="#cb52-341" aria-hidden="true" tabindex="-1"></a><span class="in">    # Compute distances: 160 random → different 40 random target (set 2)</span></span>
<span id="cb52-342"><a href="#cb52-342" aria-hidden="true" tabindex="-1"></a><span class="in">    group2_to_target_distances &lt;- compute_sample_to_population_min_distances(</span></span>
<span id="cb52-343"><a href="#cb52-343" aria-hidden="true" tabindex="-1"></a><span class="in">      dist_matrix, random_160_group2, random_40_target2)</span></span>
<span id="cb52-344"><a href="#cb52-344" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb52-345"><a href="#cb52-345" aria-hidden="true" tabindex="-1"></a><span class="in">    # Compute Anderson-Darling statistic</span></span>
<span id="cb52-346"><a href="#cb52-346" aria-hidden="true" tabindex="-1"></a><span class="in">    if(length(group1_to_target_distances) &gt; 0 &amp;&amp; length(group2_to_target_distances) &gt; 0) {</span></span>
<span id="cb52-347"><a href="#cb52-347" aria-hidden="true" tabindex="-1"></a><span class="in">      ad_result &lt;- ad.test(group1_to_target_distances, group2_to_target_distances)</span></span>
<span id="cb52-348"><a href="#cb52-348" aria-hidden="true" tabindex="-1"></a><span class="in">      clean_null_ad_statistics[i] &lt;- ad_result$ad[1, 1]</span></span>
<span id="cb52-349"><a href="#cb52-349" aria-hidden="true" tabindex="-1"></a><span class="in">    } else {</span></span>
<span id="cb52-350"><a href="#cb52-350" aria-hidden="true" tabindex="-1"></a><span class="in">      clean_null_ad_statistics[i] &lt;- NA</span></span>
<span id="cb52-351"><a href="#cb52-351" aria-hidden="true" tabindex="-1"></a><span class="in">    }</span></span>
<span id="cb52-352"><a href="#cb52-352" aria-hidden="true" tabindex="-1"></a><span class="in">  }</span></span>
<span id="cb52-353"><a href="#cb52-353" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb52-354"><a href="#cb52-354" aria-hidden="true" tabindex="-1"></a><span class="in">  # Remove any failed simulations</span></span>
<span id="cb52-355"><a href="#cb52-355" aria-hidden="true" tabindex="-1"></a><span class="in">  clean_null_ad_statistics &lt;- clean_null_ad_statistics[!is.na(clean_null_ad_statistics)]</span></span>
<span id="cb52-356"><a href="#cb52-356" aria-hidden="true" tabindex="-1"></a><span class="in">  cat("Completed", length(clean_null_ad_statistics), "successful clean null simulations\n")</span></span>
<span id="cb52-357"><a href="#cb52-357" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb52-358"><a href="#cb52-358" aria-hidden="true" tabindex="-1"></a><span class="in">  return(clean_null_ad_statistics)</span></span>
<span id="cb52-359"><a href="#cb52-359" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb52-360"><a href="#cb52-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-361"><a href="#cb52-361" aria-hidden="true" tabindex="-1"></a><span class="in"># Generate the clean null distribution</span></span>
<span id="cb52-362"><a href="#cb52-362" aria-hidden="true" tabindex="-1"></a><span class="in">clean_null_ad_distribution &lt;- generate_clean_null_ad_distribution(population_seqs, n_simulations = 500)</span></span>
<span id="cb52-363"><a href="#cb52-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-364"><a href="#cb52-364" aria-hidden="true" tabindex="-1"></a><span class="in"># Compare clean null vs original data split</span></span>
<span id="cb52-365"><a href="#cb52-365" aria-hidden="true" tabindex="-1"></a><span class="in">comparison_data &lt;- data.frame(</span></span>
<span id="cb52-366"><a href="#cb52-366" aria-hidden="true" tabindex="-1"></a><span class="in">  AD_Statistic = c(ad_distribution, clean_null_ad_distribution),</span></span>
<span id="cb52-367"><a href="#cb52-367" aria-hidden="true" tabindex="-1"></a><span class="in">  Distribution = factor(c(rep("Leave one out split 200", length(ad_distribution)),</span></span>
<span id="cb52-368"><a href="#cb52-368" aria-hidden="true" tabindex="-1"></a><span class="in">                          rep("Null all independent", length(clean_null_ad_distribution))))</span></span>
<span id="cb52-369"><a href="#cb52-369" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb52-370"><a href="#cb52-370" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-371"><a href="#cb52-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-372"><a href="#cb52-372" aria-hidden="true" tabindex="-1"></a><span class="fu">### Compare the densities of the 500 random splits AD to the null generated above</span></span>
<span id="cb52-373"><a href="#cb52-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-374"><a href="#cb52-374" aria-hidden="true" tabindex="-1"></a>This is the plot we show in  the Figure. </span>
<span id="cb52-375"><a href="#cb52-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-378"><a href="#cb52-378" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb52-379"><a href="#cb52-379" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Comparison: Original Data Split vs Fully Independent Random Null"</span></span>
<span id="cb52-380"><a href="#cb52-380" aria-hidden="true" tabindex="-1"></a><span class="co"># Create comparison plot</span></span>
<span id="cb52-381"><a href="#cb52-381" aria-hidden="true" tabindex="-1"></a>comparison_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(comparison_data, <span class="fu">aes</span>(<span class="at">x =</span> AD_Statistic, <span class="at">fill =</span> Distribution)) <span class="sc">+</span></span>
<span id="cb52-382"><a href="#cb52-382" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb52-383"><a href="#cb52-383" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Leave one out split 200"</span> <span class="ot">=</span> <span class="st">"blue"</span>, </span>
<span id="cb52-384"><a href="#cb52-384" aria-hidden="true" tabindex="-1"></a>                              <span class="st">"Null all independent"</span> <span class="ot">=</span> <span class="st">"red"</span>)) <span class="sc">+</span></span>
<span id="cb52-385"><a href="#cb52-385" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="co">#title = "Clean Comparison: Original Data Split vs Fully Independent Random Null",</span></span>
<span id="cb52-386"><a href="#cb52-386" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Anderson-Darling Statistic"</span>,</span>
<span id="cb52-387"><a href="#cb52-387" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Density"</span>,</span>
<span id="cb52-388"><a href="#cb52-388" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">"Distribution Type"</span>) <span class="sc">+</span></span>
<span id="cb52-389"><a href="#cb52-389" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb52-390"><a href="#cb52-390" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb52-391"><a href="#cb52-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-392"><a href="#cb52-392" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(comparison_plot)</span>
<span id="cb52-393"><a href="#cb52-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-394"><a href="#cb52-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-395"><a href="#cb52-395" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary statistics comparison</span></span>
<span id="cb52-396"><a href="#cb52-396" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Clean Comparison (Fully Independent):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb52-397"><a href="#cb52-397" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Original Data Split - Mean:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(ad_distribution), <span class="dv">4</span>), </span>
<span id="cb52-398"><a href="#cb52-398" aria-hidden="true" tabindex="-1"></a>    <span class="st">", Median:"</span>, <span class="fu">round</span>(<span class="fu">median</span>(ad_distribution), <span class="dv">4</span>), </span>
<span id="cb52-399"><a href="#cb52-399" aria-hidden="true" tabindex="-1"></a>    <span class="st">", 95th percentile:"</span>, <span class="fu">round</span>(<span class="fu">quantile</span>(ad_distribution, <span class="fl">0.95</span>), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb52-400"><a href="#cb52-400" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Clean Null - Mean:"</span>, <span class="fu">round</span>(<span class="fu">mean</span>(clean_null_ad_distribution), <span class="dv">4</span>), </span>
<span id="cb52-401"><a href="#cb52-401" aria-hidden="true" tabindex="-1"></a>    <span class="st">", Median:"</span>, <span class="fu">round</span>(<span class="fu">median</span>(clean_null_ad_distribution), <span class="dv">4</span>), </span>
<span id="cb52-402"><a href="#cb52-402" aria-hidden="true" tabindex="-1"></a>    <span class="st">", 95th percentile:"</span>, <span class="fu">round</span>(<span class="fu">quantile</span>(clean_null_ad_distribution, <span class="fl">0.95</span>), <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb52-403"><a href="#cb52-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-404"><a href="#cb52-404" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate p-value</span></span>
<span id="cb52-405"><a href="#cb52-405" aria-hidden="true" tabindex="-1"></a>clean_null_95th <span class="ot">&lt;-</span> <span class="fu">quantile</span>(clean_null_ad_distribution, <span class="fl">0.95</span>)</span>
<span id="cb52-406"><a href="#cb52-406" aria-hidden="true" tabindex="-1"></a>proportion_exceeding_clean_null <span class="ot">&lt;-</span> <span class="fu">mean</span>(ad_distribution <span class="sc">&gt;</span> clean_null_95th)</span>
<span id="cb52-407"><a href="#cb52-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-408"><a href="#cb52-408" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Proportion of original AD statistics exceeding clean null 95th percentile:"</span>, </span>
<span id="cb52-409"><a href="#cb52-409" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(proportion_exceeding_clean_null, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb52-410"><a href="#cb52-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-411"><a href="#cb52-411" aria-hidden="true" tabindex="-1"></a><span class="co"># This gives you a clean p-value for testing population structure</span></span>
<span id="cb52-412"><a href="#cb52-412" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Estimated p-value for test:"</span>, <span class="fu">round</span>(proportion_exceeding_clean_null, <span class="dv">4</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb52-413"><a href="#cb52-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-414"><a href="#cb52-414" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the comparison plot without the legend</span></span>
<span id="cb52-415"><a href="#cb52-415" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave("ad_fully_independent_comparison.png", comparison_plot_nt, width = 6, height = 4, dpi = 300)</span></span>
<span id="cb52-416"><a href="#cb52-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-417"><a href="#cb52-417" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-418"><a href="#cb52-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-419"><a href="#cb52-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-420"><a href="#cb52-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-421"><a href="#cb52-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-422"><a href="#cb52-422" aria-hidden="true" tabindex="-1"></a><span class="fu">## Part 4: Final Comparison through a quantile-quantile plot</span></span>
<span id="cb52-423"><a href="#cb52-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-424"><a href="#cb52-424" aria-hidden="true" tabindex="-1"></a><span class="in">```{r final-comparison}</span></span>
<span id="cb52-425"><a href="#cb52-425" aria-hidden="true" tabindex="-1"></a><span class="in">#| fig-cap: "QQ plot for AD with null on x axis and data split AD on y."</span></span>
<span id="cb52-426"><a href="#cb52-426" aria-hidden="true" tabindex="-1"></a><span class="in"># Compare ad_distribution vs clean_null_ad_distribution</span></span>
<span id="cb52-427"><a href="#cb52-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-428"><a href="#cb52-428" aria-hidden="true" tabindex="-1"></a><span class="in"># Create QQ plot data</span></span>
<span id="cb52-429"><a href="#cb52-429" aria-hidden="true" tabindex="-1"></a><span class="in">qq_data &lt;- data.frame(</span></span>
<span id="cb52-430"><a href="#cb52-430" aria-hidden="true" tabindex="-1"></a><span class="in">  clean_null = sort(clean_null_ad_distribution),</span></span>
<span id="cb52-431"><a href="#cb52-431" aria-hidden="true" tabindex="-1"></a><span class="in">  original_split = sort(ad_distribution)</span></span>
<span id="cb52-432"><a href="#cb52-432" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb52-433"><a href="#cb52-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-434"><a href="#cb52-434" aria-hidden="true" tabindex="-1"></a><span class="in"># Create QQ plot</span></span>
<span id="cb52-435"><a href="#cb52-435" aria-hidden="true" tabindex="-1"></a><span class="in">qq_plot &lt;- ggplot(qq_data, aes(x = clean_null, y = original_split)) +</span></span>
<span id="cb52-436"><a href="#cb52-436" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_point(alpha = 0.6) +</span></span>
<span id="cb52-437"><a href="#cb52-437" aria-hidden="true" tabindex="-1"></a><span class="in">  geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed",linewidth=1.5) +</span></span>
<span id="cb52-438"><a href="#cb52-438" aria-hidden="true" tabindex="-1"></a><span class="in">  labs(x = "Null Distribution AD Quantiles",</span></span>
<span id="cb52-439"><a href="#cb52-439" aria-hidden="true" tabindex="-1"></a><span class="in">       y = "Data Split AD Quantiles") +</span></span>
<span id="cb52-440"><a href="#cb52-440" aria-hidden="true" tabindex="-1"></a><span class="in">  theme_minimal()</span></span>
<span id="cb52-441"><a href="#cb52-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-442"><a href="#cb52-442" aria-hidden="true" tabindex="-1"></a><span class="in">print(qq_plot)</span></span>
<span id="cb52-443"><a href="#cb52-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-444"><a href="#cb52-444" aria-hidden="true" tabindex="-1"></a><span class="in"># Save the QQ plot</span></span>
<span id="cb52-445"><a href="#cb52-445" aria-hidden="true" tabindex="-1"></a><span class="in"># ggsave("qq_plot_null_vs_original.png", qq_plot, width = 4, height = 4, dpi = 300)</span></span>
<span id="cb52-446"><a href="#cb52-446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-447"><a href="#cb52-447" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb52-448"><a href="#cb52-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-449"><a href="#cb52-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-450"><a href="#cb52-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-451"><a href="#cb52-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-452"><a href="#cb52-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-453"><a href="#cb52-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-454"><a href="#cb52-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-455"><a href="#cb52-455" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>